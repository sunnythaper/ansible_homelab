---
- name: Generate OpenSSL private key
  become: true
  community.crypto.openssl_privatekey:
    curve: "{{ ssl_curve }}"
    owner: "{{ ssl_user_name }}"
    group: "{{ ssl_user_group }}"
    mode: "{{ ssl_mode }}"
    path: '{{ ssl_key_dir }}/{{ ssl_name }}.key'

- name: Create certificate signing request (CSR)
  become: true
  community.crypto.openssl_csr_pipe:
    common_name: '{{ ssl_name }}'
    privatekey_path: '{{ ssl_key_dir }}/{{ ssl_name }}.key'
  changed_when: false
  register: csr

- name: Create self-signed certificate from CSR
  become: true
  community.crypto.x509_certificate:
    csr_content: "{{ csr.csr }}"
    owner: "{{ ssl_user_name }}"
    group: "{{ ssl_user_group }}"
    mode: "{{ ssl_mode }}"
    path: '{{ ssl_cert_dir }}/{{ ssl_name }}.crt'
    privatekey_path: '{{ ssl_key_dir }}/{{ ssl_name }}.key'
    provider: selfsigned