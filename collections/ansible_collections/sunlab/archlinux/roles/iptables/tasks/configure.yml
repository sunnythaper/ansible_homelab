- name: Check if service is running
  become: true
  ansible.builtin.systemd:
    name: '{{ iptables_binary }}'
  register: __iptables_service

- name: Flush all tables
  become: true
  ansible.builtin.iptables:
    flush: yes
    table: '{{ item }}'
  with_items:
    - filter
    - nat
    - mangle
    - raw
    - security
  when: __iptables_service.status.ActiveState == 'inactive'

- name: Copy config template
  become: true
  ansible.builtin.template:
    src: iptables.rules.j2
    dest: '{{ iptables_rules_path }}'
    owner: root
    group: root
    mode: '{{ iptables_rules_file_mode }}'