---
- name: Install aide and aide-common
  apt:
    name: "{{ aide.packages }}"
    state: latest

- name: Check if daily aide cron exists
  stat:
    path: /etc/cron.daily/aide
  register: aidecron

- name: Copy aide service settings to /lib/systemd/system/
  template:
    src: lib/systemd/system/aidecheck.service.j2
    dest: /lib/systemd/system/aidecheck.service
    mode: 0644
    owner: root
    group: root
  when: not aidecron.stat.exists

- name: Setup aide check timer (instead of cron)
  template:
    src: lib/systemd/system/aidecheck.timer.j2
    dest: /lib/systemd/system/aidecheck.timer
    mode: 0644
    owner: root
    group: root
  when: not aidecron.stat.exists
  notify:
    - Restart systemd
    - Enable aidecheck

# - name: Copy aide configuration to /etc/aide/
#   template:
#     src: etc/aide/aide.conf.j2
#     dest: /etc/aide/aide.conf
#     owner: root
#     group: root
#     mode: 0644

- name: stat Debian aide.db
  stat:
    path: /var/lib/aide/aide.db
  register: aidedb

# - name: Initialize the aide database if it doesn't exist
#   expect:
#     command: aideinit
#     timeout: null
#     responses:
#       Question:
#         - 'Overwrite /var/lib/aide/aide.db [yN]?': 'y'
#         - 'Overwrite existing /var/lib/aide/aide.db.new [Yn]?': 'y'
#   when: not aidedb.stat.exists