---
- name: Create groups
  group:
    gid: "{{ item.gid }}"
    name: "{{ item.name }}"
    state: present
  no_log: true
  with_items:
    - "{{ users.add | default([]) }}"
    - "{{ users.sudo | default([]) }}"
    - "{{ users.system | default([]) }}"

- name: Remove users
  include_tasks: remove_users.yml
  when: users.remove is defined

- name: Add sudo users
  include_tasks: add_sudo_users.yml
  when: users.sudo is defined

- name: List home directories
  find:
    file_type: directory
    paths: /home
  register: home_directories

- name: Set home directory permissions
  file:
    mode: 0750
    path: "{{ item.path }}"
  no_log: true
  with_items: "{{ home_directories.files }}"